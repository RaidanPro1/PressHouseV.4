
<div class="h-full flex gap-6 relative">
  <!-- Tool Palette -->
  <aside class="w-64 bg-base-100 p-4 rounded-xl shadow flex-shrink-0 flex flex-col z-20">
    <h2 class="text-xl font-bold text-gray-800 mb-4">صندوق الأدوات</h2>
    <div class="flex-grow overflow-y-auto pr-2">
      @for(category of categories; track category) {
        <div class="mb-4">
          <h3 class="font-semibold text-ph-blue mb-2">{{ category }}</h3>
          <div class="space-y-2">
            @for(tool of categorizedTools()[category]; track tool.id) {
              <div 
                class="p-2 border rounded-md bg-base-200 hover:bg-gray-200 cursor-grab flex items-center gap-2 transition-colors duration-200"
                [class.bg-blue-50]="hoveredTool()?.id === tool.id"
                [class.border-blue-200]="hoveredTool()?.id === tool.id"
                [class.ring-1]="hoveredTool()?.id === tool.id"
                [class.ring-ph-blue]="hoveredTool()?.id === tool.id"
                draggable="true"
                (mouseenter)="hoveredTool.set(tool)"
                (mouseleave)="hoveredTool.set(null)"
                (dragstart)="onToolDragStart($event, tool)">
                <div class="w-6 h-6 flex items-center justify-center rounded-md flex-shrink-0" [ngClass]="tool.iconColor.replace('text-', 'bg-').replace('-500', '-100').replace('-600', '-100')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4" [ngClass]="tool.iconColor"><path stroke-linecap="round" stroke-linejoin="round" [attr.d]="tool.iconSvg" /></svg>
                </div>
                <span class="text-xs font-semibold">{{ tool.name }}</span>
              </div>
            }
          </div>
        </div>
      }
    </div>
    
    <!-- Tool Description Panel (Tooltip) -->
    <div class="mt-4 pt-4 border-t border-gray-200">
      <div class="p-3 bg-base-200/80 rounded-xl border border-gray-200 text-sm min-h-[140px] flex flex-col justify-center transition-all duration-300 relative overflow-hidden">
         @if (hoveredTool(); as tool) {
          <div class="animate-fade-in h-full flex flex-col">
            <div class="flex items-center gap-2 mb-2 pb-2 border-b border-gray-300 flex-shrink-0">
               <div class="w-6 h-6 flex items-center justify-center rounded-md" [ngClass]="tool.iconColor.replace('text-', 'bg-').replace('-500', '-100').replace('-600', '-100')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4" [ngClass]="tool.iconColor"><path stroke-linecap="round" stroke-linejoin="round" [attr.d]="tool.iconSvg" /></svg>
               </div>
               <p class="font-bold text-gray-800 text-xs">{{ tool.name }}</p>
            </div>
            <p class="text-xs text-gray-600 leading-relaxed overflow-y-auto flex-grow">{{ tool.description }}</p>
          </div>
        } @else {
          <div class="text-center text-gray-400 animate-fade-in">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 mx-auto mb-2 opacity-50"><path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg>
            <p class="text-xs">حرك المؤشر فوق أداة لعرض وظيفتها واستخداماتها</p>
          </div>
        }
      </div>
    </div>
  </aside>

  <!-- Investigation Canvas -->
  <main 
    class="flex-grow rounded-xl shadow-inner relative overflow-hidden investigation-canvas transition-colors duration-300"
    (dragover)="onCanvasDragOver($event)"
    (drop)="onCanvasDrop($event)"
    [style.background-color]="settings().backgroundColor"
    [style.background-image]="settings().showGrid ? 'radial-gradient(' + settings().gridColor + ' 1px, transparent 1px)' : 'none'"
    [style.background-size]="'20px 20px'">

    <!-- Canvas Controls -->
    <div class="absolute top-4 right-4 z-30 flex flex-col gap-2">
      <!-- File Upload -->
      <button 
        (click)="triggerFileUpload()" 
        class="p-2 rounded-full bg-white shadow-md hover:bg-gray-100 text-gray-600 transition-colors"
        title="رفع ملفات">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.112 2.13" />
        </svg>
      </button>
      <input type="file" #fileInput hidden multiple (change)="onFileSelected($event)">

      <!-- Settings Button -->
      <button 
        (click)="toggleSettings()" 
        class="p-2 rounded-full bg-white shadow-md hover:bg-gray-100 text-gray-600 transition-colors"
        title="إعدادات المظهر">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 1 1 0-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 0 1-1.44-4.282m3.102.069a18.03 18.03 0 0 1-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 0 1 8.835 2.535M10.34 6.66a23.847 23.847 0 0 0 8.835-2.535m0 0A23.74 23.74 0 0 0 18.795 3m.38 1.125a23.91 23.91 0 0 1 1.014 5.795 23.91 23.91 0 0 1-1.014 5.795m0-11.59a23.877 23.877 0 0 1 1.183.57m0 0a24.133 24.133 0 0 1 3.18 3.18C23.265 5.28 23.67 7.57 23.67 10h-2.34c-.27 0-.535-.071-.767-.179a1.5 1.5 0 0 1-.81-1.376v-.667a24.134 24.134 0 0 0-.663-5.283Z" />
        </svg>
      </button>
    </div>

    <!-- Settings Panel -->
    @if(isSettingsOpen()) {
      <div class="absolute top-32 right-4 z-30 w-72 bg-white rounded-xl shadow-xl border border-gray-200 p-4 animate-scale-in-dropdown">
        <h3 class="font-bold text-gray-800 mb-4 pb-2 border-b">تخصيص اللوحة</h3>
        <div class="space-y-4">
          <!-- Background -->
          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-gray-700">لون الخلفية</label>
            <input type="color" [ngModel]="settings().backgroundColor" (ngModelChange)="updateSetting('backgroundColor', $event)" class="w-8 h-8 rounded cursor-pointer border border-gray-300">
          </div>
          
          <!-- Grid -->
          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-gray-700">إظهار الشبكة</label>
            <input type="checkbox" [ngModel]="settings().showGrid" (ngModelChange)="updateSetting('showGrid', $event)" class="rounded text-ph-blue focus:ring-ph-blue">
          </div>
          @if(settings().showGrid) {
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium text-gray-700">لون الشبكة</label>
              <input type="color" [ngModel]="settings().gridColor" (ngModelChange)="updateSetting('gridColor', $event)" class="w-8 h-8 rounded cursor-pointer border border-gray-300">
            </div>
          }

          <hr class="border-gray-200">

          <!-- Nodes -->
          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-gray-700">لون خلفية الأدوات</label>
            <input type="color" [ngModel]="settings().nodeBackgroundColor" (ngModelChange)="updateSetting('nodeBackgroundColor', $event)" class="w-8 h-8 rounded cursor-pointer border border-gray-300">
          </div>

          <hr class="border-gray-200">

          <!-- Connections -->
          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-gray-700">لون الروابط</label>
            <input type="color" [ngModel]="settings().connectionColor" (ngModelChange)="updateSetting('connectionColor', $event)" class="w-8 h-8 rounded cursor-pointer border border-gray-300">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">نمط الخط</label>
            <select [ngModel]="settings().connectionStyle" (ngModelChange)="updateSetting('connectionStyle', $event)" class="w-full text-sm rounded border-gray-300 bg-gray-50 p-1.5">
              <option value="solid">خط متصل</option>
              <option value="dashed">خط متقطع (Dashed)</option>
              <option value="dotted">منقط (Dotted)</option>
            </select>
          </div>
          
          <button (click)="resetSettings()" class="w-full mt-2 py-1.5 text-xs text-red-600 bg-red-50 hover:bg-red-100 rounded transition-colors">استعادة الافتراضي</button>
        </div>
      </div>
    }

    <!-- SVG Layer for Connections -->
    <svg class="absolute inset-0 w-full h-full pointer-events-none">
      @for(path of connectionPaths(); track path) {
        <path 
          [attr.d]="path" 
          [attr.stroke]="settings().connectionColor" 
          [attr.stroke-width]="settings().connectionWidth" 
          [attr.stroke-dasharray]="connectionDashArray()"
          fill="none" 
          stroke-linecap="round" />
      }
      @if (connectionLinePath()) {
        <path [attr.d]="connectionLinePath()" stroke="#0D2B6B" stroke-width="2" stroke-dasharray="5 5" fill="none" />
      }
    </svg>

    <!-- Nodes Layer -->
    @for(node of nodes(); track node.id) {
      <div 
        class="absolute w-60 rounded-lg shadow-xl border-2 border-gray-200 select-none cursor-move animate-fade-in transition-colors duration-300"
        [style.left.px]="node.x"
        [style.top.px]="node.y"
        [style.background-color]="settings().nodeBackgroundColor"
        (mousedown)="onNodeDragStart($event, node.id)">
        
        <div class="p-2 border-b flex items-center gap-2 rounded-t-lg" 
             [style.background-color]="settings().nodeBackgroundColor === '#ffffff' ? '' : 'rgba(0,0,0,0.05)'"
             [ngClass]="settings().nodeBackgroundColor === '#ffffff' ? 'bg-base-100' : ''">
           <div class="w-6 h-6 flex items-center justify-center rounded-md flex-shrink-0" [ngClass]="node.iconColor.replace('text-', 'bg-').replace('-500', '-100').replace('-600', '-100')">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4" [ngClass]="node.iconColor"><path stroke-linecap="round" stroke-linejoin="round" [attr.d]="node.iconSvg" /></svg>
            </div>
          <p class="font-bold text-sm truncate" [title]="node.title">{{ node.title }}</p>
        </div>
        
        <div class="p-3 text-xs text-gray-500">
          @if (node.type === 'tool') {
             انقر "تشغيل" لفتح الأداة.
          } @else if (node.type === 'file') {
             @if (node.file?.preview) {
               <img [src]="node.file?.preview" class="w-full h-24 object-cover rounded-md border border-gray-200 mb-1">
             }
             <div class="flex justify-between items-center">
               <span>{{ node.file?.size }}</span>
               <span class="uppercase">{{ node.file?.type?.split('/')[1] || 'FILE' }}</span>
             </div>
          }
        </div>
        
        @if (node.type === 'tool' && node.tool) {
          <div class="p-2 border-t flex justify-end rounded-b-lg"
               [style.background-color]="settings().nodeBackgroundColor === '#ffffff' ? '' : 'rgba(0,0,0,0.05)'"
               [ngClass]="settings().nodeBackgroundColor === '#ffffff' ? 'bg-base-100' : ''">
            <button (click)="runNodeTool($event, node.tool)" class="px-3 py-1 text-xs font-semibold text-white bg-ph-blue rounded-md hover:bg-ph-blue-dark">تشغيل</button>
          </div>
        }

        <div 
          class="connection-point absolute -left-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-gray-300 rounded-full border-2 border-white cursor-crosshair hover:bg-ph-blue"
          title="ربط إلى هنا"
          (mouseup)="endConnection($event, node.id)">
        </div>
         <div 
          class="connection-point absolute -right-2 top-1/2 -translate-y-1/2 w-4 h-4 bg-gray-300 rounded-full border-2 border-white cursor-crosshair hover:bg-ph-blue"
          title="إنشاء اتصال من هنا"
          (mousedown)="startConnection($event, node.id)">
        </div>
        
        <button (click)="removeNode($event, node.id)" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white rounded-full text-xs leading-none hover:bg-red-700 flex items-center justify-center">&times;</button>
      </div>
    }

     @if (nodes().length === 0 && !isAiBuilding()) {
      <div class="absolute inset-0 flex items-center justify-center text-center text-gray-400 pointer-events-none">
        <div>
          <h3 class="text-xl font-semibold">لوحة التحقيقات</h3>
          <p>اسحب أداة من القائمة اليسرى، ارفع ملفات، أو استخدم شريط الأوامر.</p>
        </div>
      </div>
    }

    <!-- AI Command Bar -->
    <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-full max-w-3xl z-10">
       @if(aiError()) {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded-lg mb-2 text-sm text-center">
            {{ aiError() }}
        </div>
      }
      <div class="bg-white/80 backdrop-blur-sm rounded-xl shadow-2xl p-2 flex items-center gap-2 border border-gray-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-ph-blue flex-shrink-0 mx-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09ZM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456Z" /></svg>
        <input 
          [(ngModel)]="aiCommand"
          (keyup.enter)="buildWorkflowWithAi()"
          type="text" 
          placeholder="اطلب من الذكاء الاصطناعي بناء سير عمل لك... (مثال: ابحث عن بصمة 'raidan' الرقمية ثم أرشف النتائج)"
          class="flex-grow p-3 bg-transparent focus:outline-none text-sm w-full">
        <button (click)="buildWorkflowWithAi()" [disabled]="isAiBuilding() || !aiCommand()" class="px-5 py-2.5 font-bold text-white rounded-lg bg-ph-blue hover:bg-ph-blue-dark disabled:bg-gray-400 flex items-center justify-center w-28 flex-shrink-0">
          @if (isAiBuilding()) {
             <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
          } @else {
            <span>ابنِ</span>
          }
        </button>
      </div>
    </div>
  </main>
</div>
